# Runloop 消息循环

- ### 简介

  > - 消息循环属于线程，主线程的消息循环默认开启着，里面在等待着屏幕上的用户输入事件。
  > - 相当于给当前的代码这里插入一个while死循环而已，然后while里面可以运行代码。while循环体内的代码运行在当前线程的消息循环上，而外面的代码运行在当前线程上(非消息循环上)。

- ### 作用

  > 1. 保证程序不退出
  > 2. 接收和处理用户的事件【主线程的消息循环(while死循环)在程序加载完毕就一直在等待处理用户的输入事件】

- ### 原理

  > 就是一个死循环
  >
  > 在每次循环中，一直卡在等待用户输入信息的位置(用户触摸屏幕)
  >
  > 当用户点击屏幕(产生事件)，就会有相应的处理事件的方法被调用
  >
  > 这个方法执行完毕后，这次消息循环完毕，又重新开始下一次消息循环

- ### 注意【消息循环模式会变化】

  > 注意：
  >
  > 因为runloop在不同的情况下有不同的模式，比如当屏幕上的scrollView被拖动时，主线程的runloop就会由defaultMode模式变为UITrackingRunLoopMode，但是这两个模式都属于commonModes。如果timer源被添加在runloop的defaultMode，那它的方法在trackingMode就不会被执行，所以可以将它添加在runloop的commonModes来解决问题。

- ### 自动释放池

  - 存在意义 / 作用
    - 如果一个循环创建了大量的临时对象

      > 你可以在循环内部使用自动释放池在下次循环开始前处理掉那些对象。这样可以减少程序的最大内存使用量。

    - 如果你创建了一个子线程。

      > 你必须在子线程开始执行前立即创建自动释放池，否则你的程序会发生内存泄漏。

  - 自动释放池

    > 标记为autorelease的对象，会被添加到最近一次创建的自动释放池中
    >
    > 当自动释放池被销毁或耗尽时，会向自动释放池中的所有对象发送release消息

  - 自动释放池是什么时候创建的？又是什么时候销毁的？

    > 每一次主线程的消息循环开始的时候会先创建自动释放池
    >
    > 消息循环结束前，会释放自动释放池
    >
    > 自动释放池被销毁或耗尽时会向池中所有对象发送release消息，释放所有autorelease的对象
    >
    > 使用NSThread做多线程开发时，需要在线程调度方法中手动添加自动释放池